workflows:
  version: 2
  tests:
    jobs:
    - php56-build
    - php70-build
    - php71-build
    - php72-build

version: 2

job-references:
  mysql_image: &mysql_image
                 circleci/mysql:5.6

  setup_environment: &setup_environment
    name: "Setup Environment Variables"
    command: |
      echo "export PATH=$HOME/.composer/vendor/bin:$PATH" >> $BASH_ENV
      source /home/circleci/.bashrc

  install_dependencies: &install_dependencies
    name: "Install Dependencies"
    command: |
      #sudo apt-get update && sudo apt-get install subversion
      sudo docker-php-ext-install mysqli
      #sudo sh -c "printf '\ndeb http://ftp.us.debian.org/debian sid main\n' >> /etc/apt/sources.list"
      #sudo apt-get update && sudo apt-get install mysql-client-5.7 npm

  php_job: &php_job
    environment:
    - WP_VERSION: "latest"
    steps:
    - checkout
    - run: *setup_environment
    - run: *install_dependencies
    - run:
        name: "Run Tests"
        command: |
          #composer global require "phpunit/phpunit=5.7.*"
          #composer global require wp-coding-standards/wpcs
          #composer global require --dev jakub-onderka/php-parallel-lint
          #phpcs --config-set installed_paths $HOME/.composer/vendor/wp-coding-standards/wpcs
          #phpcs -p -s -n . --standard=./ruleset.xml --extensions=php
          #jscs -c .jscsrc .
          #jshint .
          #parallel-lint --blame --exclude node_modules --exclude vendor .
          rm -rf /tmp/wordpress-tests-lib /tmp/wordpress
          bash bin/install-wp-tests.sh wordpress_test root '' 127.0.0.1 $WP_VERSION
          phpunit --coverage-clover=build/logs/clover.xml
          WP_MULTISITE=1 phpunit --coverage-clover=build/logs/clover.xml

jobs:
  php56-build:
    <<: *php_job
    docker:
    - image: pojome/php-cli:5.6
    - image: *mysql_image

  #php56-wp-48-build:
  #  <<: *php_job
  #  environment:
  #  - WP_VERSION: "4.8"
  #  docker:
  #  - image: pojome/php-cli:5.6
  #  - image: *mysql_image
  #
  #php56-wp-47-build:
  #  <<: *php_job
  #  environment:
  #  - WP_VERSION: "4.7"
  #  docker:
  #  - image: pojome/php-cli:5.6
  #  - image: *mysql_image

  php70-build:
    <<: *php_job
    docker:
    - image: pojome/php-cli:7.0
    - image: *mysql_image

  php71-build:
    <<: *php_job
    docker:
    - image: pojome/php-cli:7.1
    - image: *mysql_image

  php72-build:
    <<: *php_job
    docker:
    - image: pojome/php-cli:7.2
    - image: *mysql_image

